---
title: Silo Management
order: 5
---

# Silo Management

Silos are ERC-4626 compliant wrappers that manage underlying yield strategies. Each vault has three silos, and as an asset manager you can configure their strategies to optimize yield on idle assets.

## Silo Types

| Silo            | Purpose                                            | Active When                       |
| --------------- | -------------------------------------------------- | --------------------------------- |
| **SyncSilo**    | Holds assets during open mode for yield generation | Vault is open                     |
| **DepositSilo** | Holds pending async deposit requests               | Vault is closed, deposits pending |
| **RedeemSilo**  | Holds settled redemption assets for claiming       | After settlement with redemptions |

## Silo Architecture

Each silo uses a **single-strategy + IDLE bucket** design:

```
┌──────────────────────────────────┐
│              Silo                │
├──────────────────────────────────┤
│                                  │
│  ┌──────────────┐  ┌──────────┐  │
│  │  Strategy    │  │  IDLE    │  │
│  │ (ERC-4626)   │  │  Bucket  │  │
│  │              │  │          │  │
│  │  e.g. AAVE   │  │ Fallback │  │
│  │  aToken      │  │ storage  │  │
│  └──────────────┘  └──────────┘  │
│                                  │
└──────────────────────────────────┘
```

- **Strategy**: An optional ERC-4626 vault (e.g., Aave aToken wrapper). Assets deposited here earn yield.
- **IDLE bucket**: Assets that remain in the silo contract. Any overflow from `strategy.maxDeposit()` stays here. The IDLE balance is tracked in storage to prevent donation attacks.

## Strategy Management

### Setting a Strategy

```solidity
// Set a new strategy for a silo (owner only)
ISilo(silo).setStrategy(IERC4626(newStrategy));

// Remove the strategy (IDLE-only mode)
ISilo(silo).setStrategy(IERC4626(address(0)));
```

When changing strategies:

1. All assets are withdrawn from the old strategy to IDLE
2. The new strategy is set
3. You must then manually allocate assets to the new strategy

### Allocating and Deallocating

```solidity
// Move assets from IDLE bucket into the strategy
ISilo(silo).allocateToStrategy(amount);

// Move assets from the strategy back to IDLE
ISilo(silo).deallocateFromStrategy(amount);
```

### Rebalancing

Rebalance moves assets between the strategy and IDLE bucket. A positive `amount` allocates to the strategy, a negative amount deallocates:

```solidity
// This is done at the vault level via scripts
// The Silo owner can allocate/deallocate as needed
```

## Changing Silos on the Vault

The vault admin can replace the silos associated with a vault:

```solidity
// Update the sync silo (requires governance admin via SET_SYNC_SILO_ROLE)
IVault(vault).setSyncSilo(IERC4626(newSyncSilo));

// Update the deposit silo
IVault(vault).setDepositSilo(IERC4626(newDepositSilo));

// Update the redeem silo
IVault(vault).setRedeemSilo(IERC4626(newRedeemSilo));
```

> **Warning:** Changing silos while they hold assets requires careful migration. The virtual shares accounting system handles the conversion automatically, but the old silo's assets must be withdrawn first.

## Virtual Shares Accounting

When a deposit silo is changed mid-cycle (while users have pending deposits), the protocol uses **virtual shares** to maintain correct proportional ownership without updating individual user mappings.

### The Problem

If the silo changes and the new silo has a different PPS, user balances stored in mappings would be incorrect:

```
Before switch (Silo A):  Alice = 500 shares   Bob = 300 shares
After switch (Silo B):   New PPS → old share counts are wrong
```

### The Solution

Virtual shares act as a stable proportional layer:

```
USER MAPPINGS (never change on silo switch):
  Alice: 500 virtual shares
  Bob:   300 virtual shares
  Total: 800 virtual shares

GLOBAL (updated on switch):
  totalVirtualShares = 800
  totalTrueShares = 640 (actual Silo B shares)

Alice's claim = 500 × (640/800) = 400 Silo B shares ✓
```

This happens automatically — no action needed from the asset manager.

## Silo PnL

Any profit or loss generated by silo strategies is handled as follows:

| Event                       | Profit            | Loss              |
| --------------------------- | ----------------- | ----------------- |
| **Deposit settlement**      | → T3tris treasury | Absorbed by vault |
| **Redeem claim**            | → T3tris treasury | Absorbed by vault |
| **Vault close (sync silo)** | → T3tris treasury | Absorbed by vault |

The key implication: **silo yield goes to the T3tris treasury, not to LPs or the asset manager.** LPs' deposit/redemption amounts remain exactly as requested.

## Default Strategy Generator

When deploying a vault through the T3tris factory, a **default strategy** is automatically generated for all three silos if a `DefaultStrategyGenerator` is configured:

```solidity
interface IDefaultStrategyGenerator {
    function generateDefaultStrategy(IERC20 asset) external returns (IERC4626 strategy_);
}
```

The reference implementation uses **AAVE v3**:

```
T3tris.deployVault(params, oracle, salt, referralCode)
  └── AAVEDefaultStrategyGenerator.generateDefaultStrategy(USDC)
        └── Deploy ERC-4626 AAVE wrapper (aUSDC)
              └── All three silos use this wrapper as their strategy
```

## Sweeping Stuck Tokens

If tokens get stuck in a silo (e.g., airdrops, misrouted transfers), the owner can sweep them:

```solidity
// Sweep stuck tokens from a silo
ISilo(silo).sweep(IERC20(token), recipient, amount);
```

**Restrictions:**

- Cannot sweep the silo's underlying asset
- Cannot sweep the silo's strategy shares
- Only the silo owner can call this

Similarly, stuck tokens in the vault can be swept:

```solidity
// Sweep stuck tokens from the vault (requires SWEEP_ROLE)
IVault(vault).sweep(IERC20(token), recipient, amount);
```

## Silo Pausability

Silos can be paused independently:

```solidity
ISilo(silo).pause();    // Pause silo operations
ISilo(silo).unpause();  // Resume silo operations
```

When a silo is paused, deposits and withdrawals to/from that silo are blocked. This can be used during strategy migrations or emergency situations.
